<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>AR Compass Markers</title>
<style>
  body { margin: 0; overflow: hidden; }
  #startBtn {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    padding: 12px 24px; font-size: 16px; z-index: 10;
  }
</style>
</head>
<body>

<button id="startBtn">شروع AR</button>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js";
import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/webxr/ARButton.js";

let camera, scene, renderer;
let heading = 0; // north orientation

//-------------------------------------------
// 1) calculate camera angle
//-------------------------------------------
function startCompass() {
  if (window.AbsoluteOrientationSensor) {
    const sensor = new AbsoluteOrientationSensor({ frequency: 60 });

    sensor.onreading = () => {
      let q = sensor.quaternion; // [x,y,z,w]
      let yaw = Math.atan2(2*(q[3]*q[2] + q[0]*q[1]), 1 - 2*(q[1]*q[1] + q[2]*q[2]));
      heading = THREE.MathUtils.radToDeg(yaw);
      if (heading < 0) heading += 360;
    };

    sensor.start();
  } 
  else if (window.DeviceOrientationEvent) {
    window.addEventListener("deviceorientationabsolute", e => {
      if (e.alpha !== null) heading = e.alpha;
    });
  }
}

//-------------------------------------------
// 2) create arrow (marker)
//-------------------------------------------
function makeArrow(colorText) {
  const group = new THREE.Group();

  const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
  const geo = new THREE.ConeGeometry(0.1, 0.3, 16);
  const arrow = new THREE.Mesh(geo, material);
  arrow.rotation.x = -Math.PI / 2;

  const canvas = document.createElement("canvas");
  canvas.width = 256; canvas.height = 128;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "white";
  ctx.font = "48px sans-serif";
  ctx.fillText(colorText, 20, 80);

  const tex = new THREE.CanvasTexture(canvas);
  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(0.6, 0.3),
    new THREE.MeshBasicMaterial({ map: tex, transparent: true })
  );
  plane.position.y = -0.35;

  group.add(arrow);
  group.add(plane);

  return group;
}

//-------------------------------------------
// 3) setup AR
//-------------------------------------------
document.getElementById("startBtn").onclick = async () => {
  document.getElementById("startBtn").style.display = "none";

  startCompass();

  renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.xr.enabled = true;
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ["hit-test"] }));

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();

  const north = makeArrow("North");
  const south = makeArrow("South");
  const east  = makeArrow("East");
  const west  = makeArrow("West");

  scene.add(north, south, east, west);

  renderer.setAnimationLoop(() => {
    if (!renderer.xr.isPresenting) return;

    const rot = THREE.MathUtils.degToRad(-heading);

    north.position.set( Math.sin(rot) * 1, 0, -Math.cos(rot) * 1 );
    south.position.set(-Math.sin(rot) * 1, 0,  Math.cos(rot) * 1 );
    east.position.set(  Math.cos(rot) * 1, 0,  Math.sin(rot) * 1 );
    west.position.set( -Math.cos(rot) * 1, 0, -Math.sin(rot) * 1 );

    renderer.render(scene, camera);
  });
};
</script>

</body>
</html>
